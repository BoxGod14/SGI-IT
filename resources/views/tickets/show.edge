<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGI-IT tickets</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/tickets.css">
    <link rel="stylesheet" href="../css/transitions.css">
</head>
<body>
  <script defer src="../js/tickets.js"></script>
    @include('partials/scripts/transitionsSwup_js.edge')   
    <script defer>
      /**
       * Función para crear los mensajes
       */
      function sendMessage() {
        //Obtener datos necesarios para el mensaje
        const data = {
          _csrf: document.querySelector('[name="_csrf"]').value,
          ticketId: {{ticket.id}},
          message: messager.value,
        }
        //Peticion ajax
        fetch("{{ route('MessagesController.store'}}", {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json', // Especificar el tipo de contenido si estás enviando datos en formato JSON
          },
          body: JSON.stringify(data)
          })
          .then(response => {
              return response.json(); // Devuelve la promesa resultante de parsear el cuerpo JSON
          })
          .then(data => {
              console.log(data.message);
              // Realizar más operaciones aquí con los datos actualizados
              document.querySelector('#response').textContent = data.message;
          })
      }    
      </script>
    <section class="container">        
        @include('partials/header.edge')
        @include('partials/nav.edge')
        <main class="tickets ticket" id="swup">
          <section id="subject">
            <p>{{ticket.subject}}</p>
            <p class="requester">
                @each(user in ticket.User)
                  @if(user.$extras.pivot_role == Roles.REQUESTER)
                    {{user.profile.fullName}}
                  @endif
                @endeach
              </p>   
          </section>
          <section id="description">
            <p>Descripción</p>
            <p>{{ticket.description}}</p>
          </section>
          <section id="messages">
            <div>
                <p>Mensajes</p>
                @each(message in ticket.message)
                    <p>{{message.message}}</p>
                @end
            </div>
            <div>
                <div id="message">
                  <p>De: {{ user.profile.fullName }}</p>
                  <form >
                      {{ csrfField() }}
                      <textarea name="message" oninput="auto_grow(this)" placeholder="Escribe un mensaje"></textarea>
                  </form>
                  <button class="buttonBaseStyle" id="hideWriter">Cancelar</button>
                  <button class="buttonBaseStyle" id="sendMessage">Enviar</button>
                </div>                
                <button class="buttonBaseStyle" id="showWriter">Escribir mensaje</button>
            </div>
          </section>
        </main>
        @include('partials/aside.edge')        
    </section>
</body>
</html>